{% extends "base.html" %}

{% block title %}Job Listings - Job Search Platform{% endblock %}

{% block content %}
<!-- Stats Header -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <div class="card">
        <div class="text-sm text-gray-400 mb-1">Total Jobs</div>
        <div class="text-3xl font-bold text-gray-100">{{ stats.total_jobs }}</div>
        {% if source_stats %}
        <div class="text-xs text-gray-500 mt-2">
            {% for src, count in source_stats.items() %}
            <span class="inline-block px-2 py-0.5 bg-gray-700 rounded mr-1">{{ src }}: {{ count }}</span>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    <div class="card">
        <div class="text-sm text-gray-400 mb-1">Applications</div>
        <div class="text-3xl font-bold text-blue-400">{{ stats.applied }}</div>
    </div>
    <div class="card">
        <div class="text-sm text-gray-400 mb-1">Interviews</div>
        <div class="text-3xl font-bold text-purple-400">{{ stats.interviews }}</div>
    </div>
    <div class="card">
        <div class="text-sm text-gray-400 mb-1">High Matches</div>
        <div class="text-3xl font-bold text-green-400">{{ stats.high_match }}</div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-6" x-data="{ showFilters: false }">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-100">Job Listings</h2>
        <div class="flex items-center space-x-3">
            {% if has_preferences %}
            <!-- Indeed Scraper Button -->
            <button onclick="scrapeIndeed()" 
                    class="px-5 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 
                           text-white rounded-lg font-semibold shadow-md hover:shadow-lg transition-all duration-200 
                           flex items-center gap-2" 
                    id="indeedBtn">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                Scrape Indeed
            </button>
            
            <!-- Adzuna Scraper Button -->
            <button onclick="scrapeAdzuna()" 
                    class="px-5 py-2.5 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 
                           text-white rounded-lg font-semibold shadow-md hover:shadow-lg transition-all duration-200 
                           flex items-center gap-2" 
                    id="adzunaBtn">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                </svg>
                Scrape Adzuna
            </button>
            {% else %}
            <a href="{{ url_for('settings') }}" 
               class="px-5 py-2.5 bg-gradient-to-r from-yellow-600 to-yellow-700 hover:from-yellow-700 hover:to-yellow-800 
                      text-white rounded-lg font-semibold shadow-md hover:shadow-lg transition-all duration-200 
                      flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Setup Required
            </a>
            {% endif %}
            <button @click="showFilters = !showFilters" 
                    class="px-5 py-2.5 bg-gray-700 hover:bg-gray-600 text-gray-100 rounded-lg font-semibold 
                           shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2 border border-gray-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                </svg>
                <span x-show="!showFilters">Show Filters</span>
                <span x-show="showFilters" x-cloak>Hide Filters</span>
            </button>
        </div>
    </div>
    
    <form method="GET" x-show="showFilters" x-cloak class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">
                    Sort By
                </label>
                <select name="sort_by" 
                        class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-gray-100 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <option value="match" {% if sort_by == 'match' %}selected{% endif %}>Match Score (High to Low)</option>
                    <option value="posted" {% if sort_by == 'posted' %}selected{% endif %}>Date Posted (Newest)</option>
                    <option value="scraped" {% if sort_by == 'scraped' %}selected{% endif %}>Date Scraped (Newest)</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">
                    Min Match Score
                </label>
                <input type="range" name="min_score" min="0" max="100" 
                       value="{{ min_score }}" 
                       class="w-full"
                       oninput="this.nextElementSibling.value = this.value + '%'">
                <output class="text-sm text-gray-400">{{ min_score }}%</output>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">
                    Location
                </label>
                <input type="text" name="location" value="{{ location }}" 
                       placeholder="e.g., Portland, OR"
                       class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-gray-100 rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">
                    Source
                </label>
                <select name="source" 
                        class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-gray-100 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Sources</option>
                    <option value="indeed" {% if source == 'indeed' %}selected{% endif %}>Indeed</option>
                    <option value="adzuna" {% if source == 'adzuna' %}selected{% endif %}>Adzuna</option>
                    <option value="linkedin" {% if source == 'linkedin' %}selected{% endif %}>LinkedIn</option>
                    <option value="ziprecruiter" {% if source == 'ziprecruiter' %}selected{% endif %}>ZipRecruiter</option>
                </select>
            </div>
        </div>
        
        <div class="flex justify-end gap-3">
            <a href="{{ url_for('index') }}" 
               class="px-6 py-2.5 bg-gray-700 hover:bg-gray-600 text-gray-100 rounded-lg font-semibold 
                      shadow-md hover:shadow-lg transition-all duration-200 border border-gray-600 
                      flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                Reset
            </a>
            <button type="submit" 
                    class="px-6 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 
                           text-white rounded-lg font-semibold shadow-md hover:shadow-lg transition-all duration-200 
                           flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Apply Filters
            </button>
        </div>
    </form>
</div>

<!-- Job Cards -->
<div class="space-y-4">
    {% if jobs.items %}
        {% for job in jobs.items %}
        <div class="card hover:shadow-md transition" 
             x-data="{ expanded: false }">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <!-- Match Score Badge -->
                    <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium mb-2
                                {% if job.match_score >= 80 %}bg-green-900 text-green-300 border border-green-700
                                {% elif job.match_score >= 60 %}bg-yellow-900 text-yellow-300 border border-yellow-700
                                {% else %}bg-red-900 text-red-300 border border-red-700{% endif %}">
                        {{ job.match_score or '?' }}% Match
                    </div>
                    
                    <!-- Job Title -->
                    <a href="{{ url_for('job_detail', job_id=job.id) }}" 
                       class="text-xl font-semibold text-gray-100 hover:text-blue-400 mb-2 inline-block transition">
                        {{ job.title }}
                    </a>
                    
                    <!-- Company & Details -->
                    <div class="flex flex-wrap items-center gap-4 text-sm text-gray-400 mb-3">
                        <span class="font-medium text-gray-300">{{ job.company or 'Unknown Company' }}</span>
                        {% if job.location %}
                        <span>{{ job.location }}</span>
                        {% endif %}
                        {% if job.salary_min and job.salary_max %}
                        <span>${{ "{:,}".format(job.salary_min) }} - ${{ "{:,}".format(job.salary_max) }}</span>
                        {% endif %}
                        <span class="px-2 py-1 bg-gray-700 rounded text-xs">{{ job.source }}</span>
                        {% if job.posted_date %}
                        <span>{{ job.posted_date.strftime('%m/%d/%Y') }}</span>
                        {% endif %}
                    </div>
                    
                    <!-- External Link -->
                    <a href="{{ job.url }}" target="_blank" 
                       class="text-sm text-blue-400 hover:text-blue-300 mb-3 inline-flex items-center gap-1">
                        View on {{ job.source.title() }}
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                    </a>
                    
                    <!-- Description Preview -->
                    {% if job.description %}
                    <p class="text-gray-400 text-sm line-clamp-2 mb-3">
                        {{ job.description[:200] }}...
                    </p>
                    {% endif %}
                </div>
                
                <!-- Actions -->
                <div class="ml-6 flex flex-col gap-2.5">
                    <a href="{{ url_for('job_detail', job_id=job.id) }}" 
                       class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold 
                              text-sm shadow-md hover:shadow-lg transition-all duration-200 text-center 
                              flex items-center justify-center gap-2 whitespace-nowrap border border-blue-500">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                        View Details
                    </a>
                    <button onclick="generateCoverLetter({{ job.id }})"
                            class="px-5 py-2.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold 
                                   text-sm shadow-md hover:shadow-lg transition-all duration-200 
                                   flex items-center justify-center gap-2 whitespace-nowrap border border-purple-500">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Cover Letter
                    </button>
                    <button onclick="markAsApplied({{ job.id }})"
                            class="px-5 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold 
                                   text-sm shadow-md hover:shadow-lg transition-all duration-200 
                                   flex items-center justify-center gap-2 whitespace-nowrap border border-green-500">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Mark Applied
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
        
        <!-- Pagination -->
        {% if jobs.pages > 1 %}
        <div class="flex justify-center items-center space-x-2 mt-8">
            {% if jobs.has_prev %}
            <a href="{{ url_for('index', page=jobs.prev_num, min_score=min_score, location=location, source=source, sort_by=sort_by) }}" 
               class="btn-secondary">
                ‚Üê Previous
            </a>
            {% endif %}
            
            <span class="text-gray-400">
                Page {{ jobs.page }} of {{ jobs.pages }}
            </span>
            
            {% if jobs.has_next %}
            <a href="{{ url_for('index', page=jobs.next_num, min_score=min_score, location=location, source=source, sort_by=sort_by) }}" 
               class="btn-secondary">
                Next ‚Üí
            </a>
            {% endif %}
        </div>
        {% endif %}
        
    {% else %}
        <!-- Empty State -->
        <div class="text-center py-12">
            <div class="text-6xl mb-4">üîç</div>
            <h3 class="text-xl font-semibold text-gray-100 mb-2">No jobs found</h3>
            <p class="text-gray-400 mb-6">
                {% if has_preferences %}
                Click "Scrape Indeed" or "Scrape Adzuna" above to find jobs
                {% else %}
                <a href="{{ url_for('settings') }}" class="text-blue-400 hover:text-blue-300">Set up your search preferences</a> to start finding jobs
                {% endif %}
            </p>
            {% if has_preferences %}
            <div class="flex gap-4 justify-center">
                <button onclick="scrapeIndeed()" 
                        class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 
                               text-white rounded-lg font-bold shadow-lg hover:shadow-xl transition-all duration-200 
                               flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    Scrape Indeed
                </button>
                <button onclick="scrapeAdzuna()" 
                        class="px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 
                               text-white rounded-lg font-bold shadow-lg hover:shadow-xl transition-all duration-200 
                               flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                    </svg>
                    Scrape Adzuna
                </button>
            </div>
            {% else %}
            <a href="{{ url_for('settings') }}" 
               class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 
                      text-white rounded-lg font-bold shadow-lg hover:shadow-xl transition-all duration-200 
                      flex items-center gap-2 mx-auto">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Go to Settings
            </a>
            {% endif %}
        </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_scripts %}
<script>
function scrapeIndeed() {
    const btn = document.getElementById('indeedBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.classList.add('btn-loading');
    btn.innerHTML = '‚è≥ Scraping Indeed...';
    
    loading.show('Scraping Indeed...');
    
    fetch('/api/scrape/indeed', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        loading.hide();
        btn.disabled = false;
        btn.classList.remove('btn-loading');
        btn.innerHTML = originalText;
        
        if (data.success) {
            toast.success(data.message);
            setTimeout(() => location.reload(), 1500);
        } else {
            toast.error(data.message);
        }
    })
    .catch(error => {
        loading.hide();
        btn.disabled = false;
        btn.classList.remove('btn-loading');
        btn.innerHTML = originalText;
        toast.error('Error scraping Indeed. Check console for details.');
        console.error(error);
    });
}

function scrapeAdzuna() {
    const btn = document.getElementById('adzunaBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.classList.add('btn-loading');
    btn.innerHTML = '‚è≥ Scraping Adzuna...';
    
    loading.show('Scraping Adzuna API...');
    
    fetch('/api/scrape/adzuna', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        loading.hide();
        btn.disabled = false;
        btn.classList.remove('btn-loading');
        btn.innerHTML = originalText;
        
        if (data.success) {
            toast.success(data.message);
            setTimeout(() => location.reload(), 1500);
        } else {
            toast.error(data.message);
        }
    })
    .catch(error => {
        loading.hide();
        btn.disabled = false;
        btn.classList.remove('btn-loading');
        btn.innerHTML = originalText;
        toast.error('Error scraping Adzuna. Check console for details.');
        console.error(error);
    });
}

function markAsApplied(jobId) {
    if (!confirm('Mark this job as applied?')) return;
    
    loading.show('Updating application status...');
    
    fetch('/api/application/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            job_id: jobId,
            status: 'applied'
        })
    })
    .then(response => response.json())
    .then(data => {
        loading.hide();
        if (data.success) {
            toast.success('Marked as applied!');
            setTimeout(() => location.reload(), 1000);
        } else {
            toast.error('Failed to update application');
        }
    })
    .catch(error => {
        loading.hide();
        toast.error('Error updating application');
        console.error(error);
    });
}

function generateCoverLetter(jobId) {
    if (!confirm('Generate AI cover letter for this job?')) return;
    
    loading.show('Generating cover letter with AI...');
    
    fetch('/api/cover-letter/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ job_id: jobId })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.message || 'Server error');
            });
        }
        return response.json();
    })
    .then(data => {
        loading.hide();
        
        if (data.success) {
            toast.success('Cover letter generated!');
            
            // Show cover letter in modal
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:999;display:flex;align-items:center;justify-content:center;padding:20px;" onclick="this.remove()">
                    <div style="background:#1f2937;padding:30px;border-radius:12px;max-width:800px;max-height:90vh;overflow-y:auto;color:#fff;box-shadow:0 20px 50px rgba(0,0,0,0.7);" onclick="event.stopPropagation()">
                        <h2 style="font-size:24px;font-weight:bold;margin-bottom:20px;color:#60a5fa;">Cover Letter</h2>
                        <div style="white-space:pre-wrap;line-height:1.8;color:#d1d5db;margin-bottom:20px;">${data.cover_letter.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                        <div style="display:flex;gap:10px;">
                            <button onclick="navigator.clipboard.writeText(\`${data.cover_letter.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`).then(() => toast.success('Copied to clipboard!'))" style="background:#3b82f6;color:white;padding:10px 20px;border-radius:6px;border:none;cursor:pointer;font-weight:500;">Copy</button>
                            <button onclick="this.closest('[style*=fixed]').remove()" style="background:#6b7280;color:white;padding:10px 20px;border-radius:6px;border:none;cursor:pointer;font-weight:500;">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        } else {
            toast.error(data.message || 'Failed to generate cover letter');
        }
    })
    .catch(error => {
        loading.hide();
        toast.error(error.message);
        console.error('Cover letter error:', error);
    });
}
</script>
{% endblock %}




