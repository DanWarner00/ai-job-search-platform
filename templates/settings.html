{% extends "base.html" %}

{% block title %}Settings - Job Search Platform{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-100">Settings</h1>
        <p class="text-gray-400 mt-2">Configure your job search</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Resume Upload -->
        <div class="card">
            <h2 class="text-xl font-semibold text-gray-100 mb-4">Resume</h2>
            
            {% if resume %}
            <div class="p-4 bg-green-900 bg-opacity-30 border border-green-700 rounded-lg mb-4">
                <div class="text-green-200 font-medium mb-2">Resume Active</div>
                <div class="text-green-300 text-sm">{{ resume.filename }}</div>
            </div>
            
            <form action="{{ url_for('upload_resume') }}" method="POST" enctype="multipart/form-data" id="resumeReplaceForm">
                <input type="file" name="resume" id="resumeReplaceInput" accept=".pdf,.docx" class="hidden" onchange="document.getElementById('resumeReplaceForm').submit()">
                <label for="resumeReplaceInput" class="btn-secondary w-full text-center block py-3 cursor-pointer">
                    Replace Resume
                </label>
            </form>
            {% else %}
            <div class="p-4 bg-yellow-900 bg-opacity-30 border border-yellow-700 rounded-lg mb-4">
                <div class="text-yellow-200 font-medium">No Resume Uploaded</div>
            </div>
            
            <form action="{{ url_for('upload_resume') }}" method="POST" enctype="multipart/form-data" id="resumeUploadForm">
                <input type="file" name="resume" id="resumeUploadInput" accept=".pdf,.docx" class="hidden" onchange="document.getElementById('resumeUploadForm').submit()">
                <label for="resumeUploadInput" class="btn-primary w-full text-center block py-3 cursor-pointer">
                    Upload Resume
                </label>
            </form>
            {% endif %}
        </div>
        
        <!-- Search Preferences -->
        <div class="card">
            <h2 class="text-xl font-semibold text-gray-100 mb-4">Job Search</h2>
            
            <form id="preferencesForm" onsubmit="savePreferences(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-200 mb-2">Job Titles</label>
                    <input type="text" name="job_titles" 
                           value="{{ prefs.job_titles if prefs else '' }}"
                           placeholder="Data Analyst, ML Engineer"
                           class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-gray-100 placeholder-gray-400 rounded-md focus:ring-blue-500 focus:border-blue-500"
                           required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-200 mb-2">Locations</label>
                    <input type="text" name="locations" 
                           value="{{ prefs.locations if prefs else 'Portland, OR' }}"
                           placeholder="Portland OR, Remote"
                           class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-gray-100 placeholder-gray-400 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-200 mb-2">Keywords (optional)</label>
                    <input type="text" name="keywords" 
                           value="{{ prefs.keywords if prefs else '' }}"
                           placeholder="Python, AI, Flask"
                           class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-gray-100 placeholder-gray-400 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-200 mb-2">Job Description (optional)</label>
                    <textarea name="search_description" rows="3"
                              placeholder="Looking for a backend Python role focused on AI/ML, preferably with LLM integration. Interested in startups or mid-size companies with good work-life balance."
                              class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-gray-100 placeholder-gray-400 rounded-md focus:ring-blue-500 focus:border-blue-500">{{ prefs.search_description if prefs else '' }}</textarea>
                    <p class="text-xs text-gray-400 mt-1">Describe the type of job you want - AI will use this for better matching</p>
                </div>
                
                <button type="submit" class="btn-primary w-full py-3">
                    Save Preferences
                </button>
            </form>
            
            {% if prefs and prefs.job_titles %}
            <div class="mt-4">
                <button onclick="scrapeJobs()" class="btn-primary w-full py-3 bg-green-600 hover:bg-green-700" id="scrapeBtn">
                    Find Jobs Now
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Quick Start Guide -->
    {% if not resume or not (prefs and prefs.job_titles) %}
    <div class="card mt-6 bg-blue-900 bg-opacity-20 border-blue-700">
        <h2 class="text-xl font-semibold text-blue-200 mb-4">Quick Start</h2>
        <div class="space-y-3 text-blue-300">
            {% if not resume %}
            <div class="flex items-center space-x-3">
                <span class="text-lg font-bold text-blue-400">1.</span>
                <div>Upload your resume to enable AI matching</div>
            </div>
            {% else %}
            <div class="flex items-center space-x-3 opacity-50">
                <span class="text-lg font-bold text-green-400">✓</span>
                <div>Resume uploaded</div>
            </div>
            {% endif %}
            
            {% if not (prefs and prefs.job_titles) %}
            <div class="flex items-center space-x-3">
                <span class="text-lg font-bold text-blue-400">2.</span>
                <div>Set your job titles and locations</div>
            </div>
            {% else %}
            <div class="flex items-center space-x-3 opacity-50">
                <span class="text-lg font-bold text-green-400">✓</span>
                <div>Preferences saved</div>
            </div>
            {% endif %}
            
            <div class="flex items-center space-x-3">
                <span class="text-lg font-bold text-blue-400">3.</span>
                <div>Click "Find Jobs Now" to start</div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_scripts %}
<script>
function scrapeJobs() {
    const btn = document.getElementById('scrapeBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = 'Scraping...';
    
    fetch('/api/scrape/run', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        
        if (data.success) {
            alert(`✅ ${data.message}\n\nGo to Applications tab to view jobs!`);
        } else {
            alert(`❌ ${data.message}`);
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        alert('❌ Error scraping jobs. Check console for details.');
        console.error(error);
    });
}

function savePreferences(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    const data = {
        job_titles: formData.get('job_titles'),
        keywords: formData.get('keywords'),
        locations: formData.get('locations'),
        search_description: formData.get('search_description'),
        min_salary: null,
        max_salary: null,
        remote_only: false
    };
    
    fetch('/api/preferences/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Preferences saved!');
            location.reload();
        } else {
            alert('❌ Error saving preferences');
        }
    })
    .catch(error => {
        alert('❌ Error saving preferences');
        console.error(error);
    });
}
</script>
{% endblock %}

